# Image Migration from OpenShift Internal Registry to GCR

The steps below are tested on a Linux box. These do not work on Google Cloud Shell. 

* Install Docker on the host.


## Connecting to OpenShift Internal Registry 

* Get OpenShift Registry URL. 

In **OpenShift 4.x** this is already exposed as `default_route`. 

```
REGISTRY_URL=$(oc get route default-route -n openshift-image-registry -o jsonpath='{.spec.host}')
```

If you are using **OpenShift 3.x**, you will have to expose it yourself, if not already done as below. Confirm that the registry service is running in `default` OpenShift project and the service name is `image-registry` before running these commands , if not you may have to change these respective values.

```
oc project default
oc create route reencrypt --service=image-registry
REGISTRY_URL=$(oc get route image-registry -n default -o jsonpath='{.spec.host}')
```


* Get Root CA certificate from the created route. The command below saves the cert in a file with name `registry_ca.crt`. 
```
openssl s_client -showcerts -connect ${REGISTRY_URL}:443 < /dev/null |  awk '/BEGIN/ {c=1; print >"registry_ca.crt"; next} /END/ {print >"registry_ca.crt"; exit}; c{print >"registry_ca.crt"}'

```

* Copy this file to `/etc/docker/certs.d` folder.

```
sudo mkdir -p /etc/docker/certs.d/$REGISTRY_URL
sudo cp registry_ca.crt /etc/docker/certs.d/$REGISTRY_URL/ca.crt
```

* Restart Docker

```
sudo systemctl restart docker
```

* Login to the OpenShift internal registry

```
sudo docker login -u `oc whoami` -p `oc whoami -t` $REGISTRY_URL
```
You should see a message `Login Succeeded`

## Connecting to Target GCR 

```
gcloud auth print-access-token | sudo docker login -u oauth2accesstoken --password-stdin https://gcr.io
```
You should see a message `Login Succeeded`




